#!/usr/bin/env ruby

$stdout.sync = true # Sync output.

# Contains the Rails application.
BUILD_DIR = ARGV[0]
# This & later buildpacks may use the cache to fetch data.
CACHE_DIR = ARGV[1]

puts  "-----> Purging .bundle directory from build and cache"
print `[ -d "#{BUILD_DIR}/.bundle" ] && rm -rf "#{BUILD_DIR}/.bundle"`
print `[ -d "#{CACHE_DIR}/.bundle" ] && rm -rf "#{CACHE_DIR}/.bundle"`

puts  "-----> Copying .heroku-bundle to .bundle"
print `mv "#{BUILD_DIR}/.heroku-bundle" "#{BUILD_DIR}/.bundle"`

# Advice from stackoverflow.com/questions/22995788
puts  "-----> Replace /app with build directory #{BUILD_DIR} for build stage, using colons"
print `sed -i "s:app:#{BUILD_DIR}:g" #{BUILD_DIR}/.bundle/config`

puts  "-----> Outputting .bundle/config contents for verification"
puts `cat #{BUILD_DIR}/.bundle/config`

puts  "-----> Caching the new bundle config"
print `mkdir -p "#{CACHE_DIR}"`
print `cp -r "#{BUILD_DIR}/.bundle" "#{CACHE_DIR}/.bundle"`
